<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Correction des lieux</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4a6fa5;
            padding-bottom: 10px;
        }
        button {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #3a5f95;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4a6fa5;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            margin: 10px 0;
        }
        pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test de correction des lieux</h1>
        
        <div class="info">
            <p>Cette page permet de tester la correction automatique des noms de lieux :</p>
            <ul>
                <li>"Base A√©rienne" ‚Üí "BA" (Bois d'Arcy)</li>
                <li>"Service des Scell√©s" ‚Üí "Scell√©s"</li>
            </ul>
        </div>

        <button onclick="testCorrection()">üß™ Tester la correction</button>
        <button onclick="forceCorrection()">üî® Forcer la correction sur la base actuelle</button>
        <button onclick="checkCurrentData()">üìä V√©rifier les donn√©es actuelles</button>
        
        <div id="results" class="results" style="display:none;"></div>
    </div>

    <script>
        // Initialiser l'application
        let app;
        
        async function initApp() {
            // Charger app.js
            const script = document.createElement('script');
            script.src = 'app.js';
            document.head.appendChild(script);
            
            // Attendre que l'app soit charg√©e
            await new Promise(resolve => {
                script.onload = resolve;
            });
            
            // Attendre un peu pour l'initialisation
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            app = window.app;
        }
        
        async function testCorrection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>‚è≥ Test en cours...</p>';
            
            try {
                await initApp();
                
                // Cr√©er des donn√©es de test
                const testData = {
                    expertises: [
                        { id: 1, lieu_examen: 'Base A√©rienne', patronyme: 'Test BA' },
                        { id: 2, lieu_examen: 'Service des Scell√©s', patronyme: 'Test Scell√©s' },
                        { id: 3, lieu_examen: 'BA', patronyme: 'D√©j√† correct BA' },
                        { id: 4, lieu_examen: 'Scell√©s', patronyme: 'D√©j√† correct Scell√©s' },
                        { id: 5, lieu_examen: 'Fleury', patronyme: 'Autre lieu' }
                    ]
                };
                
                // Sauvegarder les donn√©es actuelles
                const originalData = JSON.parse(JSON.stringify(app.database));
                
                // Appliquer les donn√©es de test
                app.database = testData;
                
                resultsDiv.innerHTML += '<h3>Donn√©es avant correction :</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(testData.expertises.map(e => ({
                    patronyme: e.patronyme,
                    lieu_examen: e.lieu_examen
                })), null, 2) + '</pre>';
                
                // Appliquer la correction
                const correctedCount = app.fixLocationNames();
                
                resultsDiv.innerHTML += '<h3>Donn√©es apr√®s correction :</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(app.database.expertises.map(e => ({
                    patronyme: e.patronyme,
                    lieu_examen: e.lieu_examen
                })), null, 2) + '</pre>';
                
                // V√©rifier les r√©sultats
                const results = app.database.expertises;
                let success = true;
                
                if (results[0].lieu_examen !== 'BA') {
                    resultsDiv.innerHTML += '<p class="error">‚ùå √âchec : "Base A√©rienne" devrait √™tre "BA"</p>';
                    success = false;
                } else {
                    resultsDiv.innerHTML += '<p class="success">‚úÖ "Base A√©rienne" corrig√© en "BA"</p>';
                }
                
                if (results[1].lieu_examen !== 'Scell√©s') {
                    resultsDiv.innerHTML += '<p class="error">‚ùå √âchec : "Service des Scell√©s" devrait √™tre "Scell√©s"</p>';
                    success = false;
                } else {
                    resultsDiv.innerHTML += '<p class="success">‚úÖ "Service des Scell√©s" corrig√© en "Scell√©s"</p>';
                }
                
                if (results[2].lieu_examen !== 'BA') {
                    resultsDiv.innerHTML += '<p class="error">‚ùå "BA" a √©t√© modifi√© alors qu\'il √©tait correct</p>';
                    success = false;
                } else {
                    resultsDiv.innerHTML += '<p class="success">‚úÖ "BA" non modifi√© (d√©j√† correct)</p>';
                }
                
                if (results[3].lieu_examen !== 'Scell√©s') {
                    resultsDiv.innerHTML += '<p class="error">‚ùå "Scell√©s" a √©t√© modifi√© alors qu\'il √©tait correct</p>';
                    success = false;
                } else {
                    resultsDiv.innerHTML += '<p class="success">‚úÖ "Scell√©s" non modifi√© (d√©j√† correct)</p>';
                }
                
                if (results[4].lieu_examen !== 'Fleury') {
                    resultsDiv.innerHTML += '<p class="error">‚ùå "Fleury" a √©t√© modifi√©</p>';
                    success = false;
                } else {
                    resultsDiv.innerHTML += '<p class="success">‚úÖ "Fleury" non modifi√© (autre lieu)</p>';
                }
                
                resultsDiv.innerHTML += `<h3>R√©sum√© : ${correctedCount} correction(s) appliqu√©e(s)</h3>`;
                
                if (success) {
                    resultsDiv.innerHTML += '<p class="success">üéâ Tous les tests ont r√©ussi !</p>';
                } else {
                    resultsDiv.innerHTML += '<p class="error">‚ö†Ô∏è Certains tests ont √©chou√©</p>';
                }
                
                // Restaurer les donn√©es originales
                app.database = originalData;
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Erreur : ${error.message}</p>`;
                console.error(error);
            }
        }
        
        async function forceCorrection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>‚è≥ Correction en cours...</p>';
            
            try {
                await initApp();
                
                const correctedCount = app.fixLocationNames();
                
                if (correctedCount > 0) {
                    resultsDiv.innerHTML = `<p class="success">‚úÖ ${correctedCount} lieu(x) corrig√©(s) avec succ√®s !</p>`;
                    resultsDiv.innerHTML += '<p class="info">Les donn√©es ont √©t√© sauvegard√©es automatiquement.</p>';
                } else {
                    resultsDiv.innerHTML = '<p class="info">‚ÑπÔ∏è Aucune correction n√©cessaire. Tous les lieux sont d√©j√† corrects.</p>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Erreur : ${error.message}</p>`;
                console.error(error);
            }
        }
        
        async function checkCurrentData() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>‚è≥ Chargement des donn√©es...</p>';
            
            try {
                await initApp();
                
                const problematicLocations = app.database.expertises.filter(exp => 
                    exp.lieu_examen === 'Base A√©rienne' || 
                    exp.lieu_examen === 'Service des Scell√©s' ||
                    exp.lieu_examen === 'Service des scell√©s'
                );
                
                if (problematicLocations.length > 0) {
                    resultsDiv.innerHTML = '<h3>‚ö†Ô∏è Lieux n√©cessitant une correction :</h3>';
                    resultsDiv.innerHTML += '<pre>' + JSON.stringify(problematicLocations.map(e => ({
                        patronyme: e.patronyme,
                        lieu_examen: e.lieu_examen,
                        date_examen: e.date_examen
                    })), null, 2) + '</pre>';
                    resultsDiv.innerHTML += `<p class="info">Trouv√© ${problematicLocations.length} expertise(s) avec des lieux √† corriger.</p>`;
                } else {
                    resultsDiv.innerHTML = '<p class="success">‚úÖ Aucun lieu probl√©matique trouv√© dans la base de donn√©es !</p>';
                }
                
                // Afficher un r√©sum√© des lieux uniques
                const uniqueLocations = [...new Set(app.database.expertises.map(e => e.lieu_examen).filter(Boolean))];
                resultsDiv.innerHTML += '<h3>Tous les lieux uniques dans la base :</h3>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(uniqueLocations.sort(), null, 2) + '</pre>';
                
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Erreur : ${error.message}</p>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>