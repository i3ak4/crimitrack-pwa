<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari iOS Test - CrimiTrack PWA</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        h1 {
            color: #1a202c;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }
        h2 {
            color: #2d3748;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        .test-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }
        .test-name {
            font-weight: 500;
            color: #4a5568;
        }
        .test-result {
            font-size: 1.2rem;
        }
        .console {
            background: #1a202c;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        .log-error { color: #ef4444; }
        .log-warn { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .log-success { color: #10b981; }
        .btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            margin-top: 10px;
        }
        .btn:active { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Safari iOS</h1>
        <p class="subtitle">Tests de compatibilit√© sp√©cifiques √† Safari/iOS</p>

        <!-- Test 1: D√©tection Safari -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ D√©tection Navigateur</h2>
            <div id="browser-tests"></div>
        </div>

        <!-- Test 2: APIs Web -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ APIs Web Support√©es</h2>
            <div id="api-tests"></div>
        </div>

        <!-- Test 3: ES6 Features -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Fonctionnalit√©s ES6</h2>
            <div id="es6-tests"></div>
        </div>

        <!-- Test 4: Module Loading -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Chargement de Modules</h2>
            <button class="btn" onclick="testModuleLoading()">Test Modules</button>
            <div id="module-tests"></div>
        </div>

        <!-- Test 5: IndexedDB -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ IndexedDB</h2>
            <button class="btn" onclick="testIndexedDB()">Test IndexedDB</button>
            <div id="indexeddb-tests"></div>
        </div>

        <!-- Console -->
        <div class="console" id="console">
            <div class="log-entry log-info">Console pr√™te...</div>
        </div>
    </div>

    <script>
        // Logging utility
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        // Test result display
        function addTestResult(containerId, testName, result) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'test-item';
            item.innerHTML = `
                <span class="test-name">${testName}</span>
                <span class="test-result">${result ? '‚úÖ' : '‚ùå'}</span>
            `;
            container.appendChild(item);
        }

        // 1. Browser Detection
        function testBrowserDetection() {
            const ua = navigator.userAgent;
            const tests = {
                'Safari': /Safari/.test(ua) && !/Chrome/.test(ua),
                'iOS': /iPhone|iPad|iPod/.test(ua),
                'iOS Safari': /iPhone|iPad|iPod/.test(ua) && /Safari/.test(ua),
                'Standalone Mode': window.navigator.standalone === true,
                'iOS Version >= 14': (() => {
                    const match = ua.match(/OS (\d+)_/);
                    return match && parseInt(match[1]) >= 14;
                })()
            };

            Object.entries(tests).forEach(([name, result]) => {
                addTestResult('browser-tests', name, result);
                log(`${name}: ${result ? 'OUI' : 'NON'}`, result ? 'success' : 'warn');
            });
        }

        // 2. Web APIs
        function testWebAPIs() {
            const apis = {
                'Service Worker': 'serviceWorker' in navigator,
                'IndexedDB': 'indexedDB' in window,
                'Local Storage': 'localStorage' in window,
                'Session Storage': 'sessionStorage' in window,
                'Fetch API': 'fetch' in window,
                'Promises': 'Promise' in window,
                'Async/Await': (async () => true)() instanceof Promise,
                'Web Workers': 'Worker' in window,
                'Push API': 'PushManager' in window,
                'Notifications': 'Notification' in window
            };

            Object.entries(apis).forEach(([name, result]) => {
                addTestResult('api-tests', name, result);
                log(`API ${name}: ${result ? 'Support√©e' : 'Non support√©e'}`, result ? 'success' : 'error');
            });
        }

        // 3. ES6 Features
        function testES6Features() {
            const tests = {};

            // Test arrow functions
            try {
                const arrow = () => true;
                tests['Arrow Functions'] = arrow();
            } catch (e) {
                tests['Arrow Functions'] = false;
            }

            // Test template literals
            try {
                const str = `test`;
                tests['Template Literals'] = true;
            } catch (e) {
                tests['Template Literals'] = false;
            }

            // Test classes
            try {
                class TestClass {}
                tests['Classes'] = true;
            } catch (e) {
                tests['Classes'] = false;
            }

            // Test let/const
            try {
                let a = 1;
                const b = 2;
                tests['Let/Const'] = true;
            } catch (e) {
                tests['Let/Const'] = false;
            }

            // Test destructuring
            try {
                const {x} = {x: 1};
                tests['Destructuring'] = x === 1;
            } catch (e) {
                tests['Destructuring'] = false;
            }

            // Test spread operator
            try {
                const arr = [...[1, 2, 3]];
                tests['Spread Operator'] = arr.length === 3;
            } catch (e) {
                tests['Spread Operator'] = false;
            }

            // Test async/await
            try {
                (async () => {})();
                tests['Async/Await'] = true;
            } catch (e) {
                tests['Async/Await'] = false;
            }

            // Test Modules (static import/export)
            tests['ES6 Modules'] = 'noModule' in HTMLScriptElement.prototype;

            Object.entries(tests).forEach(([name, result]) => {
                addTestResult('es6-tests', name, result);
                log(`ES6 ${name}: ${result ? 'Support√©' : 'Non support√©'}`, result ? 'success' : 'error');
            });
        }

        // 4. Module Loading Test
        async function testModuleLoading() {
            const container = document.getElementById('module-tests');
            container.innerHTML = '';
            
            log('Test de chargement de modules...', 'info');

            // Test 1: Script tag loading
            try {
                const script = document.createElement('script');
                script.textContent = 'window.testScriptTag = true;';
                document.head.appendChild(script);
                
                addTestResult('module-tests', 'Script Tag Direct', window.testScriptTag === true);
                log('Script tag direct: OK', 'success');
            } catch (e) {
                addTestResult('module-tests', 'Script Tag Direct', false);
                log(`Script tag direct: ${e.message}`, 'error');
            }

            // Test 2: Dynamic import
            try {
                // Note: This will fail if modules aren't served with correct MIME type
                const module = await import('./modules/dashboard/dashboard-pwa.js');
                addTestResult('module-tests', 'Dynamic Import', true);
                log('Dynamic import: OK', 'success');
            } catch (e) {
                addTestResult('module-tests', 'Dynamic Import', false);
                log(`Dynamic import: ${e.message}`, 'error');
            }

            // Test 3: Global class access
            try {
                const hasGlobalClass = typeof window.DashboardPWA === 'function';
                addTestResult('module-tests', 'Global Class Access', hasGlobalClass);
                log(`Global DashboardPWA: ${hasGlobalClass ? 'Trouv√©e' : 'Non trouv√©e'}`, hasGlobalClass ? 'success' : 'warn');
            } catch (e) {
                addTestResult('module-tests', 'Global Class Access', false);
                log(`Global class: ${e.message}`, 'error');
            }

            // Test 4: Class instantiation
            try {
                if (window.DashboardPWA) {
                    const instance = new window.DashboardPWA({
                        dataManager: {},
                        syncManager: {},
                        notificationManager: {},
                        animationEngine: {},
                        device: {}
                    });
                    addTestResult('module-tests', 'Class Instantiation', true);
                    log('Instanciation classe: OK', 'success');
                } else {
                    throw new Error('DashboardPWA not found');
                }
            } catch (e) {
                addTestResult('module-tests', 'Class Instantiation', false);
                log(`Instanciation: ${e.message}`, 'error');
            }
        }

        // 5. IndexedDB Test
        async function testIndexedDB() {
            const container = document.getElementById('indexeddb-tests');
            container.innerHTML = '';
            
            log('Test IndexedDB...', 'info');

            try {
                // Test 1: Open database
                const request = indexedDB.open('TestDB', 1);
                
                request.onsuccess = () => {
                    addTestResult('indexeddb-tests', 'Open Database', true);
                    log('IndexedDB ouvert avec succ√®s', 'success');
                    
                    const db = request.result;
                    
                    // Test 2: Check version
                    addTestResult('indexeddb-tests', 'Version Check', db.version === 1);
                    
                    // Clean up
                    db.close();
                    indexedDB.deleteDatabase('TestDB');
                };
                
                request.onerror = () => {
                    addTestResult('indexeddb-tests', 'Open Database', false);
                    log(`Erreur IndexedDB: ${request.error}`, 'error');
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Test 3: Create object store
                    try {
                        const store = db.createObjectStore('test', { keyPath: 'id' });
                        addTestResult('indexeddb-tests', 'Create Store', true);
                        log('Object store cr√©√©', 'success');
                    } catch (e) {
                        addTestResult('indexeddb-tests', 'Create Store', false);
                        log(`Erreur cr√©ation store: ${e.message}`, 'error');
                    }
                };
                
            } catch (e) {
                addTestResult('indexeddb-tests', 'IndexedDB Support', false);
                log(`IndexedDB non support√©: ${e.message}`, 'error');
            }
        }

        // Load dashboard module for testing
        const dashboardScript = document.createElement('script');
        dashboardScript.src = 'modules/dashboard/dashboard-pwa.js';
        dashboardScript.onload = () => {
            log('Module Dashboard charg√©', 'success');
        };
        dashboardScript.onerror = () => {
            log('Erreur chargement module Dashboard', 'error');
        };
        document.head.appendChild(dashboardScript);

        // Run tests on load
        window.addEventListener('DOMContentLoaded', () => {
            testBrowserDetection();
            testWebAPIs();
            testES6Features();
        });
    </script>
</body>
</html>