<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialisation Donn√©es Test - CrimiTrack PWA</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #2980b9;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #27ae60;
        }
        button.success:hover {
            background: #229954;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .data-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        h2 {
            color: #495057;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Initialisation des Donn√©es de Test - CrimiTrack PWA</h1>
        
        <div id="status-message"></div>
        
        <h2>1Ô∏è‚É£ Cr√©er des donn√©es de test propres</h2>
        <p>Cr√©er 5 expertises avec toutes les donn√©es correctement remplies (sans undefined)</p>
        <button onclick="createCleanTestData()">
            ‚ú® Cr√©er Donn√©es Propres
        </button>
        
        <h2>2Ô∏è‚É£ Cr√©er des donn√©es avec probl√®mes</h2>
        <p>Cr√©er 5 expertises avec des valeurs undefined, null, etc. pour tester la sanitisation</p>
        <button onclick="createProblematicData()">
            üêõ Cr√©er Donn√©es Probl√©matiques
        </button>
        
        <h2>3Ô∏è‚É£ V√©rifier les donn√©es actuelles</h2>
        <p>Afficher les donn√©es actuellement stock√©es dans localStorage et IndexedDB</p>
        <button onclick="checkCurrentData()">
            üîç V√©rifier Donn√©es Actuelles
        </button>
        
        <h2>4Ô∏è‚É£ Nettoyer toutes les donn√©es</h2>
        <p>Supprimer toutes les donn√©es de localStorage et IndexedDB</p>
        <button class="danger" onclick="clearAllData()">
            üóëÔ∏è Effacer Toutes les Donn√©es
        </button>
        
        <h2>5Ô∏è‚É£ Ouvrir l'application</h2>
        <p>Ouvrir CrimiTrack PWA dans un nouvel onglet</p>
        <button class="success" onclick="openApp()">
            üöÄ Ouvrir CrimiTrack PWA
        </button>
        
        <div id="data-display" class="data-section" style="display: none;">
            <h3>Donn√©es actuelles :</h3>
            <pre id="data-content"></pre>
        </div>
    </div>
    
    <script>
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function createCleanTestData() {
            const expertises = [
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: "MARTIN Sophie",
                    date_examen: "2025-08-20",
                    lieu_examen: "Palais de Justice de Paris",
                    date_naissance: "1985-03-15",
                    age: "40",
                    profession: "Ing√©nieur informatique",
                    domicile: "123 rue de la Paix, 75001 Paris",
                    magistrat: "Mme DURAND",
                    tribunal: "TJ Paris",
                    numero_parquet: "2025/123456",
                    numero_instruction: "INS-2025-789",
                    chefs_accusation: "Vol avec violence",
                    opj_greffier: "Lieutenant BERNARD",
                    type_mission: "Expertise psychiatrique",
                    statut: "programmee"
                },
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: "DUPONT Jean",
                    date_examen: "2025-08-21",
                    lieu_examen: "Tribunal de Cr√©teil",
                    date_naissance: "1990-07-22",
                    age: "35",
                    profession: "Commercial",
                    domicile: "45 avenue du G√©n√©ral, 94000 Cr√©teil",
                    magistrat: "M. LEROY",
                    tribunal: "TJ Cr√©teil",
                    numero_parquet: "2025/987654",
                    numero_instruction: "INS-2025-456",
                    chefs_accusation: "Escroquerie",
                    opj_greffier: "Brigadier PETIT",
                    type_mission: "Expertise psychologique",
                    statut: "attente"
                },
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: "MOREAU Pierre",
                    date_examen: "2025-08-19",
                    lieu_examen: "Maison d'arr√™t de Fleury-M√©rogis",
                    date_naissance: "1988-11-05",
                    age: "37",
                    profession: "Sans emploi",
                    domicile: "12 rue des Lilas, 93000 Bobigny",
                    magistrat: "Mme ROUSSEAU",
                    tribunal: "TJ Bobigny",
                    numero_parquet: "2025/555666",
                    numero_instruction: "INS-2025-321",
                    chefs_accusation: "Trafic de stup√©fiants",
                    opj_greffier: "Major GARCIA",
                    type_mission: "Expertise psychiatrique",
                    statut: "realisee"
                },
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: "LEFEBVRE Marie",
                    date_examen: "2025-08-25",
                    lieu_examen: "UHSA de Villejuif",
                    date_naissance: "1975-02-28",
                    age: "50",
                    profession: "Comptable",
                    domicile: "78 boulevard Voltaire, 75011 Paris",
                    magistrat: "M. FOURNIER",
                    tribunal: "TJ Paris",
                    numero_parquet: "2025/111222",
                    numero_instruction: "INS-2025-999",
                    chefs_accusation: "Homicide involontaire",
                    opj_greffier: "Capitaine MICHEL",
                    type_mission: "Contre-expertise",
                    statut: "programmee"
                },
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: "ROUX Thomas",
                    date_examen: "2025-08-18",
                    lieu_examen: "Cabinet m√©dical",
                    date_naissance: "1995-09-12",
                    age: "30",
                    profession: "√âtudiant",
                    domicile: "5 place de la R√©publique, 92100 Boulogne",
                    magistrat: "Mme LAMBERT",
                    tribunal: "TJ Nanterre",
                    numero_parquet: "2025/333444",
                    numero_instruction: "INS-2025-777",
                    chefs_accusation: "Agression sexuelle",
                    opj_greffier: "Lieutenant DUBOIS",
                    type_mission: "Expertise psychologique",
                    statut: "realisee"
                }
            ];
            
            const database = { expertises: expertises };
            
            // Sauvegarder dans localStorage
            localStorage.setItem('crimitrack-database', JSON.stringify(database));
            
            // Sauvegarder aussi dans IndexedDB
            saveToIndexedDB(database);
            
            showStatus('success', `‚úÖ ${expertises.length} expertises propres cr√©√©es avec succ√®s!`);
            checkCurrentData();
        }
        
        function createProblematicData() {
            const expertises = [
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: undefined,  // undefined
                    date_examen: "2025-08-20",
                    lieu_examen: "undefined",  // string "undefined"
                    date_naissance: null,  // null
                    age: "null",  // string "null"
                    profession: "",  // empty string
                    domicile: "UNDEFINED",  // uppercase
                    magistrat: "Undefined",  // mixed case
                    tribunal: "TJ Paris",
                    numero_parquet: undefined,
                    numero_instruction: null,
                    chefs_accusation: "undefined",
                    opj_greffier: "",
                    type_mission: undefined,
                    statut: "programmee"
                },
                {
                    _uniqueId: generateUniqueId(),
                    _importDate: new Date().toISOString(),
                    patronyme: "TEST undefined TEST",  // contains undefined
                    date_examen: undefined,
                    lieu_examen: "Tribunal",
                    date_naissance: "undefined",
                    age: undefined,
                    profession: null,
                    domicile: "null",
                    magistrat: "M. TEST",
                    tribunal: undefined,
                    numero_parquet: "2025/000000",
                    numero_instruction: "undefined",
                    chefs_accusation: null,
                    opj_greffier: "undefined",
                    type_mission: "",
                    statut: null
                }
            ];
            
            const database = { expertises: expertises };
            
            // Sauvegarder dans localStorage
            localStorage.setItem('crimitrack-database', JSON.stringify(database));
            
            // Sauvegarder aussi dans IndexedDB
            saveToIndexedDB(database);
            
            showStatus('error', `‚ö†Ô∏è ${expertises.length} expertises probl√©matiques cr√©√©es pour test!`);
            checkCurrentData();
        }
        
        async function saveToIndexedDB(database) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CrimiTrackDB', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('database')) {
                        db.createObjectStore('database');
                    }
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['database'], 'readwrite');
                    const store = transaction.objectStore('database');
                    
                    const putRequest = store.put({
                        data: database,
                        timestamp: new Date().toISOString()
                    }, 'main');
                    
                    putRequest.onsuccess = () => {
                        console.log('‚úÖ Donn√©es sauvegard√©es dans IndexedDB');
                        resolve();
                    };
                    
                    putRequest.onerror = () => {
                        console.error('‚ùå Erreur sauvegarde IndexedDB');
                        reject();
                    };
                };
                
                request.onerror = () => {
                    console.error('‚ùå Erreur ouverture IndexedDB');
                    reject();
                };
            });
        }
        
        async function checkCurrentData() {
            const dataDisplay = document.getElementById('data-display');
            const dataContent = document.getElementById('data-content');
            
            // V√©rifier localStorage
            const localData = localStorage.getItem('crimitrack-database');
            
            // V√©rifier IndexedDB
            const indexedData = await getFromIndexedDB();
            
            let displayText = '';
            
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    displayText += 'üì¶ localStorage:\n';
                    displayText += `- ${parsed.expertises ? parsed.expertises.length : 0} expertise(s)\n`;
                    
                    if (parsed.expertises && parsed.expertises.length > 0) {
                        displayText += '\nPremi√®re expertise:\n';
                        displayText += JSON.stringify(parsed.expertises[0], null, 2);
                    }
                } catch (e) {
                    displayText += '‚ùå Erreur parsing localStorage\n';
                }
            } else {
                displayText += '‚ùå Aucune donn√©e dans localStorage\n';
            }
            
            displayText += '\n\n';
            
            if (indexedData) {
                displayText += 'üóÑÔ∏è IndexedDB:\n';
                displayText += `- ${indexedData.expertises ? indexedData.expertises.length : 0} expertise(s)\n`;
                
                if (indexedData.expertises && indexedData.expertises.length > 0) {
                    displayText += '\nPremi√®re expertise:\n';
                    displayText += JSON.stringify(indexedData.expertises[0], null, 2);
                }
            } else {
                displayText += '‚ùå Aucune donn√©e dans IndexedDB\n';
            }
            
            dataContent.textContent = displayText;
            dataDisplay.style.display = 'block';
            
            // V√©rifier les valeurs undefined
            let undefinedCount = 0;
            if (localData) {
                const parsed = JSON.parse(localData);
                if (parsed.expertises) {
                    parsed.expertises.forEach(exp => {
                        Object.entries(exp).forEach(([key, value]) => {
                            if (value === undefined || value === 'undefined' || 
                                value === null || value === 'null' ||
                                String(value).toLowerCase().includes('undefined')) {
                                undefinedCount++;
                            }
                        });
                    });
                }
            }
            
            if (undefinedCount > 0) {
                showStatus('error', `‚ö†Ô∏è ${undefinedCount} valeur(s) probl√©matique(s) d√©tect√©e(s)!`);
            } else if (localData || indexedData) {
                showStatus('success', '‚úÖ Donn√©es trouv√©es et valides');
            } else {
                showStatus('info', '‚ÑπÔ∏è Aucune donn√©e trouv√©e');
            }
        }
        
        async function getFromIndexedDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open('CrimiTrackDB', 1);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('database')) {
                        resolve(null);
                        return;
                    }
                    
                    const transaction = db.transaction(['database'], 'readonly');
                    const store = transaction.objectStore('database');
                    const getRequest = store.get('main');
                    
                    getRequest.onsuccess = () => {
                        if (getRequest.result && getRequest.result.data) {
                            resolve(getRequest.result.data);
                        } else {
                            resolve(null);
                        }
                    };
                    
                    getRequest.onerror = () => {
                        resolve(null);
                    };
                };
                
                request.onerror = () => {
                    resolve(null);
                };
            });
        }
        
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer toutes les donn√©es?')) {
                return;
            }
            
            // Effacer localStorage
            localStorage.removeItem('crimitrack-database');
            localStorage.removeItem('crimitrack_database');
            
            // Effacer IndexedDB
            try {
                await indexedDB.deleteDatabase('CrimiTrackDB');
                console.log('‚úÖ IndexedDB supprim√©e');
            } catch (e) {
                console.error('Erreur suppression IndexedDB:', e);
            }
            
            showStatus('info', 'üóëÔ∏è Toutes les donn√©es ont √©t√© effac√©es');
            
            // V√©rifier apr√®s suppression
            setTimeout(checkCurrentData, 500);
        }
        
        function openApp() {
            window.open('index.html', '_blank');
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        // V√©rifier au chargement
        window.addEventListener('load', () => {
            checkCurrentData();
        });
    </script>
</body>
</html>