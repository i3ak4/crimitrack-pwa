<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#7c3aed">
    <meta name="description" content="CrimiTrack - Expertise Criminologique Mobile">
    <meta name="cache-control" content="no-cache">
    <meta name="version" content="5.1.0-20250814">
    
    <title>CrimiTrack PWA - Expertise Criminologique</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-touch-icon.png">
    <link rel="apple-touch-startup-image" href="assets/images/apple-touch-icon.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="mask-icon" href="assets/images/favicon.svg" color="#7c3aed">
    
    <!-- Styles PWA Optimisés -->
    <link rel="stylesheet" href="assets/css/pwa-styles.css">
    <link rel="stylesheet" href="assets/css/pwa-modules.css">
    <link rel="stylesheet" href="assets/css/pwa-animations.css">
    
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <!-- Splash Screen avec Animation Fantastique -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-logo-container">
                <div class="logo-circle">
                    <i class="fas fa-balance-scale splash-icon"></i>
                </div>
                <div class="logo-ripple"></div>
            </div>
            <h1 class="splash-title">CrimiTrack</h1>
            <p class="splash-subtitle">Expertise Criminologique</p>
            <div class="splash-loader">
                <div class="loader-track">
                    <div class="loader-progress"></div>
                </div>
            </div>
            <p class="splash-status" id="splash-status">Initialisation de l'expertise...</p>
        </div>
        <div class="splash-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
    </div>

    <!-- Header Adaptatif avec Micro-interactions -->
    <header id="app-header" class="app-header">
        <div class="header-left">
            <button id="menu-toggle" class="menu-toggle glass-button" aria-label="Menu">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="menu-tooltip">Menu</div>
            </button>
            <div class="app-branding">
                <div class="brand-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="brand-text">
                    <span class="brand-title">CrimiTrack</span>
                    <span class="brand-subtitle">PWA</span>
                </div>
            </div>
        </div>
        
        <div class="header-center">
            <div class="search-container glass-panel">
                <i class="fas fa-search search-icon"></i>
                <input type="text" 
                       id="global-search" 
                       class="search-input" 
                       placeholder="Rechercher patient, dossier..."
                       autocomplete="off">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
        
        <div class="header-right">
            <!-- Indicateur de synchronisation -->
            <div id="sync-status" class="sync-status glass-button">
                <div class="sync-icon-container">
                    <i class="fas fa-sync-alt sync-icon" id="sync-icon"></i>
                    <div class="sync-progress" id="sync-progress"></div>
                </div>
                <span class="sync-text" id="sync-text">Synchro</span>
                <span class="sync-badge" id="sync-badge">0</span>
            </div>
            
            <!-- Notifications -->
            <button id="notifications" class="notifications-button glass-button" aria-label="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notification-badge">3</span>
                <span class="notification-text">Notifications</span>
            </button>
            
            <!-- Menu paramètres simplifié -->
            <button id="settings-menu" class="settings-button glass-button" aria-label="Paramètres">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </header>

    <!-- Navigation Sidebar (Desktop/iPad) -->
    <nav id="sidebar" class="sidebar glass-panel">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-icon-container">
                    <i class="fas fa-balance-scale logo-icon"></i>
                </div>
                <h2>Navigation</h2>
            </div>
            <button id="sidebar-close" class="sidebar-close" aria-label="Fermer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Section Navigation Principale -->
            <div class="nav-section">
                <h3 class="section-title">PRINCIPAL</h3>
                <ul class="nav-list">
                    <!-- Dashboard -->
                    <li class="nav-item active" data-module="dashboard">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-tachometer-alt nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Tableau de bord</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                    
                    <!-- Agenda -->
                    <li class="nav-item" data-module="agenda">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-calendar nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Agenda</span>
                            <span class="nav-badge" id="nav-agenda-count">12</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                    
                    <!-- Liste d'attente -->
                    <li class="nav-item" data-module="waitlist">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-clock nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Liste d'attente</span>
                            <span class="nav-badge priority" id="nav-waitlist-count">5</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                    
                </ul>
            </div>

            <!-- Section Communication -->
            <div class="nav-section">
                <h3 class="section-title">COMMUNICATION</h3>
                <ul class="nav-list">
                    <!-- Convocations -->
                    <li class="nav-item" data-module="convocations">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-paper-plane nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Convocations</span>
                            <span class="nav-badge warning" id="nav-convocations-count">3</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                    
                    <!-- Publipostage -->
                    <li class="nav-item" data-module="mailing">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-envelope nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Publipostage</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Section Gestion -->
            <div class="nav-section">
                <h3 class="section-title">GESTION</h3>
                <ul class="nav-list">
                    <!-- Statistiques -->
                    <li class="nav-item" data-module="statistiques">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-chart-line nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Statistiques</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                    
                    <!-- Facturation -->
                    <li class="nav-item" data-module="billing">
                        <div class="nav-link">
                            <div class="nav-icon-container">
                                <i class="fas fa-credit-card nav-icon"></i>
                                <div class="icon-glow"></div>
                            </div>
                            <span class="nav-text">Facturation</span>
                            <span class="nav-badge success" id="nav-billing-count">187</span>
                            <div class="nav-indicator"></div>
                        </div>
                    </li>
                    
                </ul>
            </div>
        </div>
        
        <!-- Footer de la sidebar -->
        <div class="sidebar-footer">
            <div class="sync-status-sidebar">
                <div class="sync-indicator pulsing"></div>
                <div class="sync-info">
                    <span class="sync-time">Dernière sync: 13:45</span>
                    <span class="sync-status-text">iCloud actif</span>
                </div>
            </div>
            
            <div class="footer-actions">
                <button class="footer-action" title="Synchroniser maintenant">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="footer-action" title="Mode sombre">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="footer-action" title="Paramètres">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main id="main-content" class="main-content">
        <!-- Onglets visuels adaptatifs -->
        <div class="content-header">
            <div class="breadcrumb">
                <span class="breadcrumb-item">CrimiTrack</span>
                <i class="fas fa-chevron-right breadcrumb-separator"></i>
                <span class="breadcrumb-item active" id="current-module">Tableau de bord</span>
            </div>
            
            <div class="quick-actions">
                <button class="quick-action glass-button" data-action="new-patient" title="Nouveau patient">
                    <i class="fas fa-user-plus"></i>
                    <span>Nouveau</span>
                </button>
                <button class="quick-action glass-button" data-action="search" title="Recherche avancée">
                    <i class="fas fa-search"></i>
                    <span>Rechercher</span>
                </button>
                <button class="quick-action glass-button" data-action="export" title="Export données">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </button>
            </div>
        </div>
        
        <!-- Container des modules avec animations -->
        <div id="module-container" class="module-container">
            <!-- Dashboard par défaut -->
            <div id="dashboard-module" class="module-content active" data-module="dashboard">
                <div class="dashboard-grid">
                    <!-- Statistiques rapides -->
                    <div class="stats-overview glass-panel">
                        <h2 class="section-title">
                            <i class="fas fa-chart-pulse"></i>
                            Vue d'ensemble
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon agenda">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-value" id="stat-agenda">12</span>
                                    <span class="stat-label">RDV aujourd'hui</span>
                                </div>
                                <div class="stat-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+2</span>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon waitlist">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-value" id="stat-waitlist">5</span>
                                    <span class="stat-label">En attente</span>
                                </div>
                                <div class="stat-trend negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>-1</span>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon billing">
                                    <i class="fas fa-euro-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-value" id="stat-revenue">187</span>
                                    <span class="stat-label">Factures</span>
                                </div>
                                <div class="stat-trend positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>+12</span>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon sync">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-value" id="stat-sync">100%</span>
                                    <span class="stat-label">Synchronisé</span>
                                </div>
                                <div class="stat-trend stable">
                                    <i class="fas fa-check"></i>
                                    <span>OK</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions rapides -->
                    <div class="quick-actions-panel glass-panel">
                        <h2 class="section-title">
                            <i class="fas fa-bolt"></i>
                            Actions rapides
                        </h2>
                        <div class="actions-grid">
                            <button class="action-card" data-action="nouvelle-mission">
                                <div class="action-icon">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <div class="action-content">
                                    <span class="action-title">Nouvelle Mission</span>
                                    <span class="action-desc">Créer une expertise</span>
                                </div>
                            </button>
                            
                            <button class="action-card" data-action="charger-db">
                                <div class="action-icon">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <div class="action-content">
                                    <span class="action-title">Charger Base</span>
                                    <span class="action-desc">Importer JSON database</span>
                                </div>
                            </button>
                            
                            <button class="action-card" data-action="sauvegarder-db">
                                <div class="action-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="action-content">
                                    <span class="action-title">Sauvegarder Base</span>
                                    <span class="action-desc">Exporter JSON database</span>
                                </div>
                            </button>
                            
                            <button class="action-card" data-action="send-convocation">
                                <div class="action-icon">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                                <div class="action-content">
                                    <span class="action-title">Publipostage</span>
                                    <span class="action-desc">Envoyer convocations</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Agenda aperçu -->
                    <div class="agenda-preview glass-panel">
                        <h2 class="section-title">
                            <i class="fas fa-calendar-day"></i>
                            Agenda aujourd'hui
                        </h2>
                        <div class="agenda-timeline" id="agenda-preview">
                            <!-- Sera rempli dynamiquement -->
                            <div class="timeline-loading">
                                <div class="loading-skeleton"></div>
                                <div class="loading-skeleton"></div>
                                <div class="loading-skeleton"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Autres modules seront chargés dynamiquement -->
        </div>
    </main>

    <!-- Navigation bottom pour mobile uniquement -->
    <nav id="bottom-nav" class="bottom-nav glass-panel">
        <button class="bottom-nav-item active" data-module="dashboard">
            <div class="nav-icon-wrapper">
                <i class="fas fa-tachometer-alt"></i>
                <div class="nav-ripple"></div>
            </div>
            <span>Accueil</span>
        </button>
        
        <button class="bottom-nav-item" data-module="agenda">
            <div class="nav-icon-wrapper">
                <i class="fas fa-calendar"></i>
                <div class="nav-ripple"></div>
            </div>
            <span>Agenda</span>
            <span class="mobile-badge">12</span>
        </button>
        
        <button class="bottom-nav-item" data-module="waitlist">
            <div class="nav-icon-wrapper">
                <i class="fas fa-clock"></i>
                <div class="nav-ripple"></div>
            </div>
            <span>Attente</span>
            <span class="mobile-badge priority">5</span>
        </button>
        
        <button class="bottom-nav-item" data-module="convocations">
            <div class="nav-icon-wrapper">
                <i class="fas fa-paper-plane"></i>
                <div class="nav-ripple"></div>
            </div>
            <span>Convoc</span>
            <span class="mobile-badge warning">3</span>
        </button>
        
        <button class="bottom-nav-item" data-module="more">
            <div class="nav-icon-wrapper">
                <i class="fas fa-ellipsis-h"></i>
                <div class="nav-ripple"></div>
            </div>
            <span>Plus</span>
        </button>
    </nav>

    <!-- Overlay pour la navigation mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Modal système pour interactions importantes -->
    <div id="modal-system" class="modal-system">
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modal-title">Titre</h3>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-actions" id="modal-actions">
                <!-- Actions dynamiques -->
            </div>
        </div>
    </div>

    <!-- Input file caché pour charger la base de données -->
    <input type="file" id="db-file-input" accept=".json" style="display: none;">

    <!-- Toast notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Installation PWA prompt -->
    <div id="install-prompt" class="install-prompt glass-panel">
        <div class="install-content">
            <div class="install-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="install-text">
                <h3>Installer CrimiTrack</h3>
                <p>Accédez rapidement à vos expertises depuis votre écran d'accueil</p>
            </div>
        </div>
        <div class="install-actions">
            <button id="install-accept" class="install-btn primary">
                <i class="fas fa-download"></i>
                Installer
            </button>
            <button id="install-dismiss" class="install-btn secondary">
                Plus tard
            </button>
        </div>
    </div>

    <!-- Protection DOM contre les erreurs -->
    <script src="assets/js/dom-safe.js"></script>
    
    <!-- Scripts PWA optimisés -->
    <script src="assets/js/real-data-manager.js"></script>
    <!-- Temporaire: version simplifiée pour Safari iOS -->
    <script src="assets/js/sync-manager-simple.js?v=2.0.0"></script>
    <!-- <script src="assets/js/sync-manager.js"></script> -->
    <script src="assets/js/offline-manager.js"></script>
    <script src="assets/js/connection-manager.js"></script>
    <script src="assets/js/log-manager.js"></script>
    <script src="assets/js/publipostage-manager.js"></script>
    
    <!-- Modules PWA -->
    <script src="modules/dashboard/dashboard-pwa.js"></script>
    <script src="modules/agenda/agenda-pwa.js"></script>
    <script src="modules/waitlist/waitlist-pwa.js"></script>
    <script src="modules/planning/planning-pwa.js"></script>
    <script src="modules/convocations/convocations-pwa.js"></script>
    <script src="modules/mailing/mailing-pwa.js"></script>
    <script src="modules/import/import-pwa.js"></script>
    <script src="modules/synthese/synthese-pwa.js"></script>
    <script src="modules/statistiques/statistiques-pwa.js"></script>
    <script src="modules/billing/billing-pwa.js"></script>
    <script src="modules/anonymisation/anonymisation-pwa.js"></script>
    <script src="modules/prompt-mastering/prompt-mastering-pwa.js"></script>
    
    <!-- Application principale -->
    <script src="assets/js/app.js"></script>
    
    <!-- Service Worker -->
    <script>
        // Service Worker avec gestion d'erreur robuste
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('service-worker.js');
                    console.log('✅ Service Worker enregistré:', registration.scope);
                    
                    // Gestion des mises à jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast('Nouvelle version disponible. Veuillez rafraîchir.', 'info', {
                                        action: { text: 'Rafraîchir', callback: () => window.location.reload() }
                                    });
                                }
                            });
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ Erreur Service Worker:', error);
                }
            });
        }
        
        // Gestion de l'installation PWA
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Montrer le prompt personnalisé après un délai
            setTimeout(() => {
                document.getElementById('install-prompt').style.display = 'flex';
                document.getElementById('install-prompt').classList.add('show');
            }, 10000); // 10 secondes après le chargement
        });
        
        // Actions installation
        document.getElementById('install-accept')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('🔧 Installation PWA:', outcome);
                deferredPrompt = null;
                document.getElementById('install-prompt').classList.remove('show');
            }
        });
        
        document.getElementById('install-dismiss')?.addEventListener('click', () => {
            document.getElementById('install-prompt').classList.remove('show');
        });
        
        // Gestion de l'état online/offline
        window.addEventListener('online', () => {
            showToast('Connexion rétablie', 'success');
            document.body.classList.remove('offline');
        });
        
        window.addEventListener('offline', () => {
            showToast('Mode hors-ligne activé', 'info');
            document.body.classList.add('offline');
        });
    </script>
</body>
</html>